{% extends 'partials/base.html.twig' %}
{% block content %}

{# Header #} 
{% if page.header.title %}
    {% include 'partials/hero.html.twig' %}
{% endif %}

<div class="px-6 py-4 xl:px-8 xl:py-12 bg-gray-100">
    <div class="flex flex-row flex-wrap">
      {# ✅ left #}
      <main role="main" class="w-full lg:w-2/3 xl:w-3/4 pt-1 px-4 py-6 xl:px-8 xl:py-12 rounded-3xl shadow-xl mb-12 bg-white bg-opacity-90">

        {% if page.content %}
          <div class="flex-col space-y-8">

            <div class="paragraph">
              <h1 class="text-4xl font-semibold pb-4">{{ page.header.hero_title|raw }}</h1>
              <p>{{ page.content|raw }}</p>
            </div>

            {# ✅ project Images #}
            {% if header.project_media %}
              <section>
                <div class="w-full">
                  {% for file in header.project_media %}
                    {% set image = page.media.images[file.name] %}
                    {% set video = page.media.files[file.name] %}
                    
                    {% if image %}
                      <img
                        src="{{ image.url }}"
                        alt="{{ file.name }}"
                        class="w-full my-4 rounded-xl shadow cursor-pointer hover:shadow-lg transition-shadow duration-300"
                        loading="lazy"
                        onclick="openModal({{ loop.index0 }})"
                      />
                    {% elseif video and video.type starts with 'video' %}
                      <video
                        controls
                        class="w-full my-4"
                        preload="metadata"
                        onclick="openModal({{ loop.index0 }})"
                      >
                        <source src="{{ video.url }}" type="{{ video.type }}">
                        Your browser does not support the video tag.
                      </video>
                    {% endif %}
                  {% endfor %}
                </div>
              </section>
            {% endif %}

          </div>
        {% endif %}
      </main>

      {# ✅ right #}
      <aside class="w-full lg:w-1/3 xl:w-3/12 {#bg-amber-200#}">

        <div class="sticky top-0 pt-1 pb-2 xl:px-12 xl:py-16 ml-12 mb-12 rounded-3xl shadow-xl space-y-6 bg-slate-50 bg-opacity-90">

        {% if page.parent %}
          <a href="{{ page.parent.url }}" class="inline-flex items-center text-primary-50 hover:underline">
            ← Back to {{ page.parent.title }}
          </a>
        {% endif %}
        
        {% if page.header.client %}
        <h1 class="text-3xl">
          {{page.header.client}}
        </h1>
        {% endif %}

        {% if page.header.role %}
        <div class="pb-2">
          <label class="text-sm font-medium text-gray-500">Role</label>
          <p class="text-gray-900">{{page.header.role}}</p>
        </div>
        {% endif %}

        {% if page.header.duration %}
        <div class="pb-2">
          <label class="text-sm font-medium text-gray-500">Duration</label>
          <p class="text-gray-900">{{page.header.duration}}</p>
        </div>
        {% endif %}

        {% if page.header.tags %}
        <div class="p-2">
          <ul class="flex space-x-2">
            {% for tag in page.header.tags %}
              <li class="rounded-full bg-primary-100 bold text-black px-4 py-1">{{ tag }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        {% if header.project_url %}
        <div class="pb-2">
          <a class="btn-primary" href="{{header.project_url}}" target="_blank">Visit site</a>
        </div>
        {% endif %}

        </div>
      </aside>
      
      {# ✅ under content #}
      <div class=" bg-gray-200 w-full flex flex-row pb-2 xl:px-12 xl:py-16 rounded-3xl shadow-lg">
        <div class="w-full pr-4">
          <h2 class="text-3xl py-2">Challenge</h2>
          <p class="text-gray-900">{{header.challenge}}</p>
        </div>
        <div class="w-full pl-4">
          <h2 class="text-3xl py-2">Solution</h2>
          <p class="text-gray-900">{{header.solution}}</p>
        </div>
      </div>

      {# ✅ design Process #}
      <div class=" bg-black text-white w-full mt-12 flex flex-row pb-2 xl:px-12 xl:py-16 rounded-3xl shadow-lg">
        <div class="w-full pr-4">
          <h2 class="text-3xl py-2">Design Process</h2>
        </div>
        <div class="w-full pl-4">
          <h2 class="text-3xl py-2">wdwhkwjdhj dwjkdhwjkdwhkjw dhjkwdh dwkjh wdjkhdw jk dwkjdw hkjwdhwdjk. dwkjhwdkjhdwkj h</h2>
          <p class="text-white">{{header.solution}}</p>
        </div>
      </div>

    </div>

</div>

{# ✅ Profile Section (optional structured content) #}
{% if page.header.profile %}
    <section class="mx-0 my-0 flex-none lg:flex space-y-6 px-6 py-4 xl:px-16 xl:py-16">
        <div class="flex flex-col lg:flex-row w-full space-y-4">
            <div class="content-center w-56 h-auto space-y-4 px-6 {# bg-red-300 #} m-auto lg:m">
            {# Image Content #}
                {% set profileImage = page.media[page.header.profile.image] ?? null %}
                
                {% if profileImage %}
                <img 
                    src="{{ profileImage.url }}"
                    alt="{{ page.header.profile.name ?: 'Profile Picture' }}" 
                    class="transition-transform duration-300 hover:scale-105"
                    loading="lazy"
                >
                {% endif %}
            </div>
            <div class="flex-1 w-full content-center space-y-4 px-6 {# bg-orange-300 #} text-center lg:text-left">
            {# Text Content #}
                <h2 class="text-3xl">{{ page.header.profile.name }}</h2>
                <p class="text-lg">{{ page.header.profile.bio }}</p>
            </div>
        </div>
        <div class="flex flex-col xl:flex-row flex-auto w-auto {# bg-blue-300 #}">
            <h3 class="w-full lg:w-80 content-center text-2xl leading-10 text-center lg:text-left px-2 lg:px-6">
            {# Skills Content #}
                {{ header.columnl.skills | raw }}
            </h3>
            <h3 class="w-full lg:w-80 content-center text-2xl leading-10 text-center lg:text-left px-2 lg:px-6">
            {# Skills Content #}
                {{ header.columnr.skills | raw }}
            </h3>  
        </div>
    </section>
{% endif %}


{# ✅ Modal Optimizado con Navegación #}
<div
  id="mediaModal"
  class="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 hidden"
  onclick="closeModal()"
>
  <div
    class="relative w-full h-full max-w-[98vw] max-h-[98vh] flex items-center justify-center"
    onclick="event.stopPropagation()"
  >
    {# Botón Cerrar #}
    <button
      class="absolute top-4 right-4 text-white text-3xl hover:text-gray-300 z-10 bg-black/50 rounded-full w-12 h-12 flex items-center justify-center transition-colors duration-200"
      onclick="closeModal()"
    >&times;</button>

    {# Flecha Izquierda #}
    <button
      id="prevBtn"
      class="absolute left-4 top-1/2 transform -translate-y-1/2 text-white text-4xl hover:text-gray-300 z-10 bg-black/50 rounded-full w-12 h-12 flex items-center justify-center transition-all duration-200 hover:bg-black/70"
      onclick="navigateModal(-1)"
    >&#8249;</button>

    {# Flecha Derecha #}
    <button
      id="nextBtn"
      class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white text-4xl hover:text-gray-300 z-10 bg-black/50 rounded-full w-12 h-12 flex items-center justify-center transition-all duration-200 hover:bg-black/70"
      onclick="navigateModal(1)"
    >&#8250;</button>

    {# Contenido del Modal #}
    <div id="modalContent" class="w-full h-full flex items-center justify-center p-4">
      {# contenido dinámico insertado por JS #}
    </div>

    {# Contador de Posición #}
    <div
      id="mediaCounter"
      class="absolute bottom-4 left-1/2 transform -translate-x-1/2 text-white bg-black/50 px-3 py-1 rounded-full text-sm"
    >
      <span id="currentMedia">1</span> / <span id="totalMedia">1</span>
    </div>
  </div>
</div>

<script>
  // Variables globales para el modal
  let currentMediaIndex = 0;
  let mediaItems = [];

  // Inicializar array de medios al cargar la página
  document.addEventListener('DOMContentLoaded', function() {
    // Construir array de medios desde el backend
    mediaItems = [
      {% for file in header.project_media %}
        {% set image = page.media.images[file.name] %}
        {% set video = page.media.videos[file.name] %}
        {% set media_file = page.media.files[file.name] %}
        {% set extension = file.name|split('.')|last|lower %}
        {% set video_extensions = ['mp4', 'webm', 'mov', 'avi', 'mkv'] %}
        {
          name: '{{ file.name|e('js') }}',
          type: '{{ extension }}',
          url: '{{ page.url }}/{{ file.name|e('js') }}',
          {% if image %}
          mediaType: 'image'
          {% elseif video %}
          mediaType: 'video'
          {% elseif extension in video_extensions %}
          mediaType: 'video'
          {% else %}
          mediaType: 'unknown'
          {% endif %}
        }{% if not loop.last %},{% endif %}
      {% endfor %}
    ];
    
    // Actualizar contador total
    document.getElementById('totalMedia').textContent = mediaItems.length;
  });

  function openModal(index) {
    currentMediaIndex = index;
    const modal = document.getElementById('mediaModal');
    updateModalContent();
    updateNavigationButtons();
    updateCounter();
    modal.classList.remove('hidden');
    
    // Prevenir scroll del body
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    const modal = document.getElementById('mediaModal');
    const content = document.getElementById('modalContent');
    modal.classList.add('hidden');
    content.innerHTML = '';
    
    // Restaurar scroll del body
    document.body.style.overflow = 'auto';
  }

  function navigateModal(direction) {
    currentMediaIndex += direction;
    
    // Wrap around navigation
    if (currentMediaIndex >= mediaItems.length) {
      currentMediaIndex = 0;
    } else if (currentMediaIndex < 0) {
      currentMediaIndex = mediaItems.length - 1;
    }
    
    updateModalContent();
    updateNavigationButtons();
    updateCounter();
  }

  function updateModalContent() {
    const content = document.getElementById('modalContent');
    const media = mediaItems[currentMediaIndex];
    
    if (!media) return;
    
    const isVideo = media.mediaType === 'video' || ['mp4', 'webm', 'mov'].includes(media.type);
    const isImage = media.mediaType === 'image' || ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(media.type);

    if (isImage) {
      content.innerHTML = `
        <img 
          src="${media.url}" 
          alt="${media.name}" 
          class="max-w-full max-h-full object-contain rounded shadow-2xl"
          style="max-height: calc(100vh - 8rem);"
        />`;
    } else if (isVideo) {
      content.innerHTML = `
        <video 
          controls 
          autoplay 
          class="max-w-full max-h-full object-contain rounded shadow-2xl"
          style="max-height: calc(100vh - 8rem);"
        >
          <source src="${media.url}" type="video/${media.type}">
          Tu navegador no soporta el tag de video.
        </video>`;
    } else {
      content.innerHTML = `<p class="text-white text-center">Tipo de archivo no soportado</p>`;
    }
  }

  function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    
    // Mostrar/ocultar botones si solo hay un elemento
    if (mediaItems.length <= 1) {
      prevBtn.style.display = 'none';
      nextBtn.style.display = 'none';
    } else {
      prevBtn.style.display = 'flex';
      nextBtn.style.display = 'flex';
    }
  }

  function updateCounter() {
    document.getElementById('currentMedia').textContent = currentMediaIndex + 1;
  }

  // Navegación con teclado
  document.addEventListener('keydown', function(e) {
    const modal = document.getElementById('mediaModal');
    if (!modal.classList.contains('hidden')) {
      switch(e.key) {
        case 'Escape':
          closeModal();
          break;
        case 'ArrowLeft':
          navigateModal(-1);
          break;
        case 'ArrowRight':
          navigateModal(1);
          break;
      }
    }
  });

  // Soporte para gestos táctiles (móvil)
  let touchStartX = 0;
  let touchEndX = 0;

  document.getElementById('mediaModal').addEventListener('touchstart', function(e) {
    touchStartX = e.changedTouches[0].screenX;
  });

  document.getElementById('mediaModal').addEventListener('touchend', function(e) {
    touchEndX = e.changedTouches[0].screenX;
    handleGesture();
  });

  function handleGesture() {
    const modal = document.getElementById('mediaModal');
    if (modal.classList.contains('hidden')) return;
    
    const swipeThreshold = 50;
    const diff = touchStartX - touchEndX;
    
    if (Math.abs(diff) > swipeThreshold) {
      if (diff > 0) {
        // Swipe left - next image
        navigateModal(1);
      } else {
        // Swipe right - previous image
        navigateModal(-1);
      }
    }
  }
</script>
  
{% endblock %}